<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íí… ë§ˆì§„ìœ¨ ê³„ì‚°ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <style>
    :root {
      --primary-color: #4A90E2;
      --secondary-color: #F5F7FA;
      --text-color: #2C3E50;
      --border-color: #E1E8ED;
      --success-color: #2ECC71;
      --danger-color: #E74C3C;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #F8F9FA;
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin-bottom: 20px;
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 2.2em;
    }

    .mode-selector {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      padding: 20px;
      background-color: var(--secondary-color);
      border-radius: 8px;
    }

    .mode-selector label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background-color: white;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mode-selector input[type="radio"] {
      display: none;
    }

    .mode-selector input[type="radio"]:checked+label {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
    }



    button {
      width: 100%;
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #357ABD;
    }

    #result {
      display: none;
      margin-top: 30px;
    }

    .result-section {
      background-color: var(--secondary-color);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .result-section h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .result-section p {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .result-section p:last-child {
      border-bottom: none;
    }

    .result-section .label {
      font-weight: 500;
    }

    .result-section .value {
      font-weight: 700;
    }

    .positive {
      color: var(--success-color);
    }

    .negative {
      color: var(--danger-color);
    }

    .saved-item {
      background-color: var(--secondary-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary-color);
    }

    .saved-item h4 {
      margin: 0 0 10px 0;
      color: var(--primary-color);
    }

    .saved-item-data {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .saved-item-data p {
      margin: 5px 0;
      font-size: 0.9em;
    }

    .saved-item-actions {
      display: flex;
      gap: 10px;
    }

    .saved-item-actions button {
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .tab-container {
      display: flex;
      background-color: var(--secondary-color);
      border-radius: 8px;
      padding: 5px;
      margin-bottom: 20px;
      gap: 5px;
    }

    .tab-button {
      flex: 1;
      padding: 12px 20px;
      background-color: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background-color: var(--primary-color);
      color: white;
    }

    .tab-button:hover:not(.active) {
      background-color: rgba(74, 144, 226, 0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
    #savedDataList::-webkit-scrollbar {
      width: 8px;
    }

    #savedDataList::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    #savedDataList::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }

    #savedDataList::-webkit-scrollbar-thumb:hover {
      background: #4a9eff;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 15px;
      }

      .mode-selector {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>íí… ë§ˆì§„ìœ¨ ê³„ì‚°ê¸°</h1>

    <div class="tab-container">
      <button class="tab-button active" onclick="switchTab('calculator', this)">ğŸ§® ê³„ì‚°ê¸°</button>
      <button class="tab-button" onclick="switchTab('saved-list', this)">ğŸ“‹ ì €ì¥ ëª©ë¡</button>
    </div>

    <div id="calculator-tab" class="tab-content active">


      <div class="input-group">
        <label for="exchangeRate">í™˜ìœ¨ (ì›/ì—”)</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="number" id="exchangeRate" step="0.01" readonly style="flex:1">
          <button onclick="updateExchangeRate()" style="width: auto; padding: 12px 20px;">í™˜ìœ¨ ì—…ë°ì´íŠ¸</button>
        </div>
        <small style="color: #666; display: block; margin-top: 5px;">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span
            id="lastUpdateTime">-</span></small>
      </div>

      <div class="input-group">
        <label for="productPrice">ì œí’ˆ ì›ê°€ (ì›)</label>
        <input type="number" id="productPrice" placeholder="ì œí’ˆì˜ ì›ê°€ë¥¼ ì›í™”ë¡œ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div id="marginModeInputs">
        <div class="input-group">
          <label>íŒë§¤ê°€</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div style="flex: 1;">
              <input type="number" id="sellingPriceKRW" placeholder="íŒë§¤ê°€ë¥¼ ì›í™”ë¡œ ì…ë ¥í•˜ì„¸ìš”" oninput="convertToJPY(this.value)">
              <small style="color: #666;">ì›í™”</small>
            </div>
            <div style="flex: 1;">
              <input type="number" id="sellingPriceJPY" placeholder="íŒë§¤ê°€ë¥¼ ì—”í™”ë¡œ ì…ë ¥í•˜ì„¸ìš”" oninput="convertToKRW(this.value)">
              <small style="color: #666;">ì—”í™”</small>
            </div>
          </div>
        </div>
      </div>

      <div class="input-group">
        <label for="discountRate">í• ì¸ìœ¨ (%)</label>
        <input type="number" id="discountRate" value="0" min="0" max="100" step="0.01" placeholder="í• ì¸ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div class="input-group">
        <label for="additionalCost">ë¶€ìì¬ ë¹„ìš© (ì›)</label>
        <input type="number" id="additionalCost" value="0" placeholder="ì¶”ê°€ ë¹„ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div class="input-group">
        <label for="vatRefund">ë¶€ê°€ì„¸ í™˜ê¸‰ë¥  (%)</label>
        <input type="number" id="vatRefund" value="10" min="0" max="100" step="0.01" placeholder="ë¶€ê°€ì„¸ í™˜ê¸‰ë¥ ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div class="input-group">
        <label for="shippingProvider">ë°°ì†¡ëŒ€í–‰ì§€</label>
        <select id="shippingProvider">
          <option value="KSE_air">KSE í•­ê³µ</option>
          <option value="KSE_sea">KSE í•´ìƒ</option>
          <option value="Synergy_slim">Synergy ìŠ¬ë¦¼</option>
          <option value="Synergy_svip">Synergy SVIP</option>
          <option value="Trackslosis">íŠ¸ë™ìŠ¬ë¡œì‹œìŠ¤</option>
        </select>
      </div>

      <div class="input-group">
        <label for="weight">ë¬´ê²Œ (kg)</label>
        <input type="number" id="weight" step="0.01" placeholder="ë¬´ê²Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div class="input-group">
        <label for="coupangFee">íí… ìˆ˜ìˆ˜ë£Œ (%)</label>
        <input type="number" id="coupangFee" value="10" min="0" max="100" step="0.01" placeholder="íí… ìˆ˜ìˆ˜ë£Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <div style="display: flex; gap: 10px;">
        <button onclick="calculate()" style="flex: 1;">ê³„ì‚°í•˜ê¸°</button>
        <button onclick="resetForm()" style="flex: 1; background-color: #95a5a6;">ğŸ”„ ì´ˆê¸°í™”</button>
      </div>

      <div id="result">


        <div class="result-section">
          <h3>ë¹„ìš© ê³„ì‚°</h3>
          <p><span class="label">ì´ êµ¬ë§¤ ê¸ˆì•¡</span> <span class="value" id="totalPriceKRW"></span></p>
          <p><span class="label">ë¶€ìì¬ ë¹„ìš©</span> <span class="value" id="totalAdditionalCost"></span></p>
          <p><span class="label">ë°°ì†¡ë¹„</span> <span class="value" id="shippingFee"></span></p>

          <p><span class="label">ì´ ë¹„ìš©</span> <span class="value" id="totalCost"></span></p>
        </div>

        <div class="result-section">
          <h3>ìˆ˜ìµ ê³„ì‚°</h3>
          <p><span class="label">íŒë§¤ê°€(ì—”)</span> <span class="value" id="resultSellingPriceJPY"></span></p>
          <p><span class="label">íŒë§¤ê°€(ì›)</span> <span class="value" id="resultSellingPriceKRW"></span></p>
          <p><span class="label">í• ì¸ ê¸ˆì•¡</span> <span class="value" id="discountAmount"></span></p>
          <p><span class="label">ì‹¤ì œ íŒë§¤ê°€</span> <span class="value" id="actualSellingPrice"></span></p>
          <p><span class="label">íí… ìˆ˜ìˆ˜ë£Œ</span> <span class="value" id="coupangFeeAmount"></span></p>
        </div>

        <div class="result-section">
          <h3>ìµœì¢… ê²°ê³¼</h3>
          <p><span class="label">ë§ˆì§„ ê¸ˆì•¡</span> <span class="value" id="marginAmount"></span></p>
          <p><span class="label">ë§ˆì§„ìœ¨</span> <span class="value" id="marginRate"></span></p>
          <p><span class="label">ë¶€ê°€ì„¸ í™˜ê¸‰</span> <span class="value positive" id="vatRefundAmount">-</span></p>
          <p style="border-top: 2px solid var(--primary-color); padding-top: 10px; margin-top: 10px;"><span
              class="label" style="font-weight: 700; font-size: 1.1em;">ì‹¤ì œ ìˆ˜ìµ (ë§ˆì§„+í™˜ê¸‰)</span> <span class="value"
              style="font-weight: 700; font-size: 1.1em;" id="totalProfit"></span></p>

          <div style="margin-top: 20px; text-align: center;">
            <button onclick="saveCalculation()"
              style="background-color: var(--success-color); padding: 15px 30px; font-size: 1.1em;" disabled
              id="saveBtn">ğŸ“Œ ì´ ê³„ì‚° ì €ì¥í•˜ê¸°</button>
          </div>

        </div>
      </div>
    </div>

    <div id="saved-list-tab" class="tab-content">
      <!-- ìƒë‹¨ ê³ ì • ì˜ì—­ -->
      <div
        style=" background-color: white; z-index: 10; padding: 20px 0; border-bottom: 1px solid #ddd; margin-bottom: 20px;">
        <h2 style="margin: 0 0 15px 0;">ì €ì¥ëœ ê³„ì‚° ëª©ë¡</h2>

        <!-- ë“œë˜ê·¸ì•¤ë“œë¡­ ì˜ì—­ -->
        <div id="dropZone"
          style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background-color: #f9f9f9; transition: all 0.3s ease; cursor: pointer;">
          <div style="color: #666; pointer-events: none;">
            <span style="font-size: 24px;">ğŸ“</span><br>
            <strong>ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</strong><br>
            <small>âš ï¸ ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ëŒ€ì²´í•©ë‹ˆë‹¤</small><br>
            <small style="color: #999; margin-top: 5px; display: block;">
              ğŸ’¡ ì´ ê³„ì‚°ê¸°ì—ì„œ "ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°"ë¡œ ìƒì„±í•œ íŒŒì¼ë§Œ ì§€ì›
            </small>
          </div>
          <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>

        <div style="display: flex; gap: 10px;">
          <button onclick="exportToExcel()" style="background-color: var(--success-color); flex: 1; padding: 12px;">ğŸ“Š
            ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
          <button onclick="clearAllData()" style="background-color: var(--danger-color); flex: 1; padding: 12px;">ğŸ—‘ï¸ ì „ì²´
            ì‚­ì œ</button>
        </div>
      </div>

      <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë°ì´í„° ëª©ë¡ ì˜ì—­ -->
      <div id="savedDataList" style="max-height: calc(90vh - 300px); overflow-y: auto; padding-right: 10px;">
        <!-- ì €ì¥ëœ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>

  <script>
    function toggleMode() {
      const mode = document.querySelector('input[name="calcMode"]:checked').value;
      document.getElementById('marginModeInputs').style.display = mode === 'margin' ? 'block' : 'none';
    }

    // ë°°ì†¡ë¹„ ìš”ê¸ˆí‘œ ë°ì´í„°
    const shippingRates = [
      { weight_kg: 0.1, KSE_air: 490, KSE_sea: 450, Synergy_slim: 540, Synergy_svip: 465, Trackslosis: 540 },
      { weight_kg: 0.25, KSE_air: 560, KSE_sea: 525, Synergy_slim: null, Synergy_svip: null, Trackslosis: null },
      { weight_kg: 0.3, KSE_air: null, KSE_sea: null, Synergy_slim: 598, Synergy_svip: 523, Trackslosis: 590 },
      { weight_kg: 0.5, KSE_air: 620, KSE_sea: 590, Synergy_slim: 665, Synergy_svip: 590, Trackslosis: 650 },
      { weight_kg: 0.7, KSE_air: null, KSE_sea: null, Synergy_slim: 725, Synergy_svip: 650, Trackslosis: null },
      { weight_kg: 0.75, KSE_air: 700, KSE_sea: 680, Synergy_slim: null, Synergy_svip: null, Trackslosis: 720 },
      { weight_kg: 1, KSE_air: 750, KSE_sea: 720, Synergy_slim: 777, Synergy_svip: 702, Trackslosis: 770 },
      { weight_kg: 1.25, KSE_air: 780, KSE_sea: 760, Synergy_slim: null, Synergy_svip: null, Trackslosis: null },
      { weight_kg: 1.5, KSE_air: 830, KSE_sea: 810, Synergy_slim: 880, Synergy_svip: 805, Trackslosis: 850 },
      { weight_kg: 1.75, KSE_air: 880, KSE_sea: 860, Synergy_slim: null, Synergy_svip: null, Trackslosis: null },
      { weight_kg: 2, KSE_air: 940, KSE_sea: 910, Synergy_slim: 980, Synergy_svip: 905, Trackslosis: 960 },
      { weight_kg: 2.5, KSE_air: 1090, KSE_sea: 950, Synergy_slim: 1130, Synergy_svip: 1055, Trackslosis: 1110 },
      { weight_kg: 3, KSE_air: 1197, KSE_sea: 1020, Synergy_slim: 1240, Synergy_svip: 1165, Trackslosis: 1167 }
    ];

    function calculateShippingFee(weight, shippingProvider, exchangeRate) {
      if (!weight || weight <= 0) {
        return { fee: 0, feeJPY: 0, weightRange: '0kg', provider: shippingProvider };
      }

      // ì…ë ¥í•œ ë¬´ê²Œë³´ë‹¤ í° ì²« ë²ˆì§¸ ë¬´ê²Œ êµ¬ê°„ì„ ì°¾ê¸°
      let selectedRate = null;
      for (let rate of shippingRates) {
        if (weight <= rate.weight_kg && rate[shippingProvider] !== null) {
          selectedRate = rate;
          break;
        }
      }

      // í•´ë‹¹ ë¬´ê²Œ êµ¬ê°„ì´ ì—†ê±°ë‚˜ ìš”ê¸ˆì´ nullì¸ ê²½ìš°, ê°€ì¥ í° ë¬´ê²Œ êµ¬ê°„ ì‚¬ìš©
      if (!selectedRate) {
        for (let i = shippingRates.length - 1; i >= 0; i--) {
          if (shippingRates[i][shippingProvider] !== null) {
            selectedRate = shippingRates[i];
            break;
          }
        }
      }

      if (!selectedRate) {
        return { fee: 0, feeJPY: 0, weightRange: 'ìš”ê¸ˆ ì •ë³´ ì—†ìŒ', provider: shippingProvider };
      }

      const feeJPY = selectedRate[shippingProvider];
      const feeKRW = Math.round(feeJPY * exchangeRate);

      return {
        fee: feeKRW,
        feeJPY: feeJPY,
        weightRange: `${selectedRate.weight_kg}kg ê¸°ì¤€`,
        provider: shippingProvider
      };
    }

    // í™˜ìœ¨ API í˜¸ì¶œ í•¨ìˆ˜
    async function fetchExchangeRate() {
      try {
        const response = await fetch('https://m.search.naver.com/p/csearch/content/qapirender.nhn?key=calculator&pkid=141&q=%ED%99%98%EC%9C%A8&where=m&u1=keb&u6=standardUnit&u7=0&u3=JPY&u4=KRW&u8=down&u2=1');
        const data = await response.json();
        if (data && data.country && data.country.length > 1) {
          const rate = parseFloat(data.country[1].value);
          document.getElementById('exchangeRate').value = rate;
          document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString();
          return rate;
        }
      } catch (error) {
        console.error('í™˜ìœ¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
        alert('í™˜ìœ¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
      return null;
    }

    // í™˜ìœ¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateExchangeRate(isAlert = false) {
      const button = document.querySelector('button[onclick="updateExchangeRate()"]');
      button.disabled = true;
      button.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘...';

      const rate = await fetchExchangeRate();

      button.disabled = false;
      button.textContent = 'í™˜ìœ¨ ì—…ë°ì´íŠ¸';


    }

    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    function switchTab(tabName, clickedButton = null) {
      // ëª¨ë“  íƒ­ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // ì„ íƒëœ íƒ­ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
      if (clickedButton) {
        clickedButton.classList.add('active');
      } else {
        // í”„ë¡œê·¸ë˜ë° ë°©ì‹ìœ¼ë¡œ í˜¸ì¶œëœ ê²½ìš°, í•´ë‹¹ íƒ­ ë²„íŠ¼ ì°¾ì•„ì„œ í™œì„±í™”
        const tabButtons = document.querySelectorAll('.tab-button');
        if (tabName === 'calculator') {
          tabButtons[0].classList.add('active');
        } else if (tabName === 'saved-list') {
          tabButtons[1].classList.add('active');
        }
      }

      // ì„ íƒëœ íƒ­ ì»¨í…ì¸  ë³´ì´ê¸°
      document.getElementById(tabName + '-tab').classList.add('active');

      // ì €ì¥ ëª©ë¡ íƒ­ìœ¼ë¡œ ì „í™˜ì‹œ ë°ì´í„° ë¡œë“œ ë° íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
      if (tabName === 'saved-list') {
        loadSavedData();
        // ì•½ê°„ì˜ ì§€ì—° í›„ íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™” (DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„)
        setTimeout(() => {
          initializeFileUpload();
        }, 100);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ìœ¨ ìë™ ì—…ë°ì´íŠ¸ ë° ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
    window.addEventListener('load', function () {
      updateExchangeRate();
      loadSavedData();
    });

    // í™˜ìœ¨ ë³€í™˜ í•¨ìˆ˜ë“¤
    function convertToJPY(krwValue) {
      if (!krwValue) {
        document.getElementById('sellingPriceJPY').value = '';
        return;
      }
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);
      if (exchangeRate) {
        const jpyValue = Math.round(krwValue / exchangeRate);
        document.getElementById('sellingPriceJPY').value = jpyValue;
      }
    }

    function convertToKRW(jpyValue) {
      if (!jpyValue) {
        document.getElementById('sellingPriceKRW').value = '';
        return;
      }
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);
      if (exchangeRate) {
        const krwValue = Math.round(jpyValue * exchangeRate);
        document.getElementById('sellingPriceKRW').value = krwValue;
      }
    }

    function calculate() {
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);
      const productPrice = parseFloat(document.getElementById('productPrice').value);
      const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
      const additionalCost = parseFloat(document.getElementById('additionalCost').value) || 0;
      const vatRefundRate = parseFloat(document.getElementById('vatRefund').value) || 0;
      const weight = parseFloat(document.getElementById('weight').value) || 0;
      const shippingProvider = document.getElementById('shippingProvider').value;
      const coupangFeeRate = parseFloat(document.getElementById('coupangFee').value) || 0;

      if (!exchangeRate || !productPrice) {
        alert('í•„ìˆ˜ í•­ëª©(í™˜ìœ¨, ì œí’ˆì›ê°€)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!document.getElementById('sellingPriceKRW').value) {
        alert('íŒë§¤ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!weight || weight <= 0) {
        alert('ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }



      // ë°°ì†¡ë¹„ ê³„ì‚°
      const shippingResult = calculateShippingFee(weight, shippingProvider, exchangeRate);

      // ë¶€ê°€ì„¸ í™˜ê¸‰ ê³„ì‚° (ë¶€ê°€ì„¸ í¬í•¨ê°€ê²© ê¸°ì¤€)
      // ê³µê¸‰ê°€ì•¡ = ë¶€ê°€ì„¸í¬í•¨ê°€ê²© Ã· 1.1, ë§¤ì…ì„¸ì•¡ = ê³µê¸‰ê°€ì•¡ Ã— 0.1 = ë¶€ê°€ì„¸í¬í•¨ê°€ê²© Ã· 11
      const vatRefundAmount = Math.round(productPrice / 11);

      // ë¹„ìš© ê³„ì‚°
      const totalCost = productPrice + additionalCost + shippingResult.fee;

      // íŒë§¤ê°€ ê³„ì‚°
      const sellingPriceKRW = parseFloat(document.getElementById('sellingPriceKRW').value);
      const sellingPriceJPY = parseFloat(document.getElementById('sellingPriceJPY').value);
      const discountAmount = sellingPriceKRW * (discountRate / 100);
      const actualSellingPrice = sellingPriceKRW - discountAmount;
      const coupangFeeAmount = actualSellingPrice * (coupangFeeRate / 100);
      const marginAmount = actualSellingPrice - totalCost - coupangFeeAmount;
      const marginRate = (marginAmount / totalCost) * 100;

      // ì‹¤ì œ ìˆ˜ìµ (ë§ˆì§„ + ë¶€ê°€ì„¸ í™˜ê¸‰)
      const totalProfit = marginAmount + vatRefundAmount;

      // ê²°ê³¼ í‘œì‹œ
      document.getElementById('totalPriceKRW').textContent = productPrice.toLocaleString() + 'ì›';
      document.getElementById('totalAdditionalCost').textContent = additionalCost.toLocaleString() + 'ì›';
      document.getElementById('shippingFee').textContent = shippingResult.fee.toLocaleString() + 'ì›';
      document.getElementById('vatRefundAmount').textContent = '+' + vatRefundAmount.toLocaleString() + 'ì›';
      document.getElementById('totalCost').textContent = totalCost.toLocaleString() + 'ì›';
      document.getElementById('resultSellingPriceJPY').textContent = sellingPriceJPY.toFixed(0) + 'ì—”';
      document.getElementById('resultSellingPriceKRW').textContent = sellingPriceKRW.toLocaleString() + 'ì›';
      document.getElementById('discountAmount').textContent = discountAmount.toLocaleString() + 'ì›';
      document.getElementById('actualSellingPrice').textContent = actualSellingPrice.toLocaleString() + 'ì›';
      document.getElementById('coupangFeeAmount').textContent = coupangFeeAmount.toLocaleString() + 'ì›';
      document.getElementById('marginAmount').textContent = marginAmount.toLocaleString() + 'ì›';
      document.getElementById('marginRate').textContent = marginRate.toFixed(2) + '%';
      document.getElementById('totalProfit').textContent = totalProfit.toLocaleString() + 'ì›';

      document.getElementById('result').style.display = 'block';
      updateResultStyles(marginAmount, marginRate, totalProfit);

      // ì €ì¥í•˜ê¸° ë²„íŠ¼ í™œì„±í™”
      document.getElementById('saveBtn').disabled = false;
    }

    function updateResultStyles(marginAmount, marginRate, totalProfit) {
      const marginAmountElement = document.getElementById('marginAmount');
      const marginRateElement = document.getElementById('marginRate');
      const totalProfitElement = document.getElementById('totalProfit');

      marginAmountElement.className = marginAmount >= 0 ? 'value positive' : 'value negative';
      marginRateElement.className = marginRate >= 0 ? 'value positive' : 'value negative';
      totalProfitElement.className = totalProfit >= 0 ? 'value positive' : 'value negative';
    }

    // ê³„ì‚° ê²°ê³¼ ì €ì¥
    function saveCalculation() {
      const productName = prompt('ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš” (í•„ìˆ˜):');

      // ì·¨ì†Œí•˜ê±°ë‚˜ ë¹ˆ ê°’ì¸ ê²½ìš° ì €ì¥í•˜ì§€ ì•ŠìŒ
      if (!productName) {
        alert('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
        return;
      }
      if (productName.trim() === '') {
        alert('ì œí’ˆëª…ì„ ì…ë ¥í•´ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      const data = {
        id: Date.now(),
        productName: productName,
        savedAt: new Date().toLocaleString(),
        inputs: {
          exchangeRate: parseFloat(document.getElementById('exchangeRate').value), // ì €ì¥ ì‹œì ì˜ í˜„ì¬ í™˜ìœ¨
          productPrice: parseFloat(document.getElementById('productPrice').value),
          sellingPriceKRW: parseFloat(document.getElementById('sellingPriceKRW').value),
          sellingPriceJPY: parseFloat(document.getElementById('sellingPriceJPY').value),
          discountRate: parseFloat(document.getElementById('discountRate').value) || 0,
          additionalCost: parseFloat(document.getElementById('additionalCost').value) || 0,
          weight: parseFloat(document.getElementById('weight').value) || 0,
          shippingProvider: document.getElementById('shippingProvider').value,
          coupangFeeRate: parseFloat(document.getElementById('coupangFee').value) || 0,
          vatRefundRate: parseFloat(document.getElementById('vatRefund').value) || 10
        },
        results: {
          totalCost: parseFloat(document.getElementById('totalCost').textContent.replace(/[ì›,]/g, '')),
          shippingFee: parseFloat(document.getElementById('shippingFee').textContent.replace(/[ì›,]/g, '')),
          vatRefundAmount: parseFloat(document.getElementById('vatRefundAmount').textContent.replace(/[+ì›,]/g, '')),
          marginAmount: parseFloat(document.getElementById('marginAmount').textContent.replace(/[ì›,]/g, '')),
          marginRate: parseFloat(document.getElementById('marginRate').textContent.replace(/%/g, '')),
          totalProfit: parseFloat(document.getElementById('totalProfit').textContent.replace(/[ì›,]/g, ''))
        }
      };

      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const savedData = JSON.parse(localStorage.getItem('marginCalculations') || '[]');
      savedData.push(data);

      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      localStorage.setItem('marginCalculations', JSON.stringify(savedData));

      alert('ê³„ì‚° ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      loadSavedData();
    }

    // ì €ì¥ëœ ë°ì´í„° ë¡œë“œ
    function loadSavedData() {
      const savedData = JSON.parse(localStorage.getItem('marginCalculations') || '[]');
      const list = document.getElementById('savedDataList');

      if (savedData.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ì €ì¥ëœ ê³„ì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      list.innerHTML = '';

      savedData.reverse().forEach(data => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        item.innerHTML = `
          <h4>${data.productName}</h4>
          <p style="color: #666; font-size: 0.8em; margin-bottom: 10px;">ì €ì¥ì¼ì‹œ: ${data.savedAt}</p>
          <div class="saved-item-data">
            <p><strong>ì œí’ˆì›ê°€:</strong> ${data.inputs.productPrice.toLocaleString()}ì›</p>
            <p><strong>íŒë§¤ê°€:</strong> ${data.inputs.sellingPriceKRW.toLocaleString()}ì› (${Number(data.inputs.sellingPriceJPY).toLocaleString()}ì—”)</p>
            <p><strong>ì´ë¹„ìš©:</strong> ${data.results.totalCost.toLocaleString()}ì›</p>
            <p><strong>ë§ˆì§„:</strong> ${data.results.marginAmount.toLocaleString()}ì› (${data.results.marginRate.toFixed(2)}%)</p>
            <p><strong>ë¶€ê°€ì„¸í™˜ê¸‰:</strong> +${data.results.vatRefundAmount.toLocaleString()}ì›</p>
            <p><strong>ì‹¤ì œìˆ˜ìµ:</strong> ${data.results.totalProfit.toLocaleString()}ì›</p>
          </div>
          <div class="saved-item-actions">
            <button onclick="loadCalculation(${data.id})" style="background-color: var(--primary-color);">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button onclick="deleteSavedItem(${data.id})" style="background-color: var(--danger-color);">ì‚­ì œ</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // ì €ì¥ëœ ê³„ì‚° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadCalculation(id) {
      const savedData = JSON.parse(localStorage.getItem('marginCalculations') || '[]');
      const data = savedData.find(item => item.id === id);

      if (!data) return;

      // ê³„ì‚°ê¸° íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
      switchTab('calculator');

      // í™˜ìœ¨ì€ í˜„ì¬ í™˜ìœ¨ ìœ ì§€ (ì €ì¥ëœ í™˜ìœ¨ ë¬´ì‹œ)
      // document.getElementById('exchangeRate').value = data.inputs.exchangeRate;
      document.getElementById('productPrice').value = data.inputs.productPrice;
      document.getElementById('sellingPriceKRW').value = data.inputs.sellingPriceKRW;
      document.getElementById('sellingPriceJPY').value = data.inputs.sellingPriceJPY;
      document.getElementById('discountRate').value = data.inputs.discountRate;
      document.getElementById('additionalCost').value = data.inputs.additionalCost;
      document.getElementById('weight').value = data.inputs.weight;

      // ë°°ì†¡ëŒ€í–‰ì§€ ì„¤ì • ë””ë²„ê¹…
      const shippingProvider = data.inputs.shippingProvider;
      console.log(`ë¶ˆëŸ¬ì˜¤ê¸° - ì €ì¥ëœ ë°°ì†¡ëŒ€í–‰ì§€: "${shippingProvider}"`);

      const shippingSelect = document.getElementById('shippingProvider');
      const validOptions = ['KSE_air', 'KSE_sea', 'Synergy_slim', 'Synergy_svip', 'Trackslosis'];

      if (validOptions.includes(shippingProvider)) {
        shippingSelect.value = shippingProvider;
        console.log(`ë¶ˆëŸ¬ì˜¤ê¸° - ë°°ì†¡ëŒ€í–‰ì§€ ì„¤ì • ì„±ê³µ: "${shippingSelect.value}"`);
      } else {
        console.warn(`ë¶ˆëŸ¬ì˜¤ê¸° - ìœ íš¨í•˜ì§€ ì•Šì€ ë°°ì†¡ëŒ€í–‰ì§€: "${shippingProvider}" â†’ ê¸°ë³¸ê°’ ì‚¬ìš©`);
        shippingSelect.value = 'KSE_air'; // ê¸°ë³¸ê°’
      }

      document.getElementById('coupangFee').value = data.inputs.coupangFeeRate;
      document.getElementById('vatRefund').value = data.inputs.vatRefundRate || 10;

      // ìë™ìœ¼ë¡œ ê³„ì‚° ì‹¤í–‰
      calculate();

      const currentRate = parseFloat(document.getElementById('exchangeRate').value);
      alert(`ê³„ì‚° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!\n\nğŸ’¡ í˜„ì¬ í™˜ìœ¨(${currentRate.toFixed(2)}ì›/ì—”)ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // ì €ì¥ëœ í•­ëª© ì‚­ì œ
    function deleteSavedItem(id) {
      if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const savedData = JSON.parse(localStorage.getItem('marginCalculations') || '[]');
      const filteredData = savedData.filter(item => item.id !== id);
      localStorage.setItem('marginCalculations', JSON.stringify(filteredData));

      loadSavedData();
    }

    // ì „ì²´ ë°ì´í„° ì‚­ì œ
    function clearAllData() {
      if (!confirm('ëª¨ë“  ì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      localStorage.removeItem('marginCalculations');
      loadSavedData();
      alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // í¼ ì´ˆê¸°í™” í•¨ìˆ˜
    function resetForm() {
      if (!confirm('ëª¨ë“  ì…ë ¥ ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (í™˜ìœ¨ ì œì™¸)
      document.getElementById('productPrice').value = '';
      document.getElementById('sellingPriceKRW').value = '';
      document.getElementById('sellingPriceJPY').value = '';
      document.getElementById('discountRate').value = '0';
      document.getElementById('additionalCost').value = '0';
      document.getElementById('weight').value = '';
      document.getElementById('shippingProvider').selectedIndex = 0;
      document.getElementById('coupangFee').value = '10';

      // ê²°ê³¼ í™”ë©´ ìˆ¨ê¸°ê¸°
      document.getElementById('result').style.display = 'none';

      // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.getElementById('saveBtn').disabled = true;

      alert('ì…ë ¥ ë‚´ìš©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜ (ExcelJS ì‚¬ìš©)
    async function exportToExcel() {
      const savedData = JSON.parse(localStorage.getItem('marginCalculations') || '[]');

      if (savedData.length === 0) {
        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ExcelJS ì›Œí¬ë¶ ìƒì„±
      const workbook = new ExcelJS.Workbook();
      const worksheet = workbook.addWorksheet('íí… ë§ˆì§„ìœ¨ ê³„ì‚°');

      // í—¤ë” ì •ì˜
      const headers = [
        'ìˆœë²ˆ', 'ì œí’ˆëª…', 'ì €ì¥ì¼ì‹œ', 'í™˜ìœ¨', 'ì œí’ˆì›ê°€', 'íŒë§¤ê°€(ì›)', 'íŒë§¤ê°€(ì—”)',
        'í• ì¸ìœ¨(%)', 'ë¶€ìì¬ë¹„ìš©', 'ë¬´ê²Œ(kg)', 'ë°°ì†¡ëŒ€í–‰ì§€', 'íí…ìˆ˜ìˆ˜ë£Œ(%)',
        'ë¶€ê°€ì„¸í™˜ê¸‰ë¥ (%)', 'ì´ë¹„ìš©', 'ë°°ì†¡ë¹„', 'ë¶€ê°€ì„¸í™˜ê¸‰', 'ë§ˆì§„ìœ¨(%)', 'ë§ˆì§„ê¸ˆì•¡', 'ì‹¤ì œìˆ˜ìµ'
      ];

      // í—¤ë” ì¶”ê°€
      worksheet.addRow(headers);

      // í—¤ë” ìŠ¤íƒ€ì¼ë§ (ë³¼ë“œì²´, ë°°ê²½ìƒ‰, í…Œë‘ë¦¬)
      const headerRow = worksheet.getRow(1);
      headerRow.eachCell((cell) => {
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FF4472C4' }
        };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        };
      });

      // í˜„ì¬ í™˜ìœ¨ ê°€ì ¸ì˜¤ê¸°
      const currentExchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0;

      // ë°ì´í„° ì¶”ê°€
      savedData.forEach((item, index) => {
        const row = [
          index + 1,
          item.productName,
          item.savedAt,
          currentExchangeRate, // í•­ìƒ í˜„ì¬ í™˜ìœ¨ ì‚¬ìš©
          Number(item.inputs.productPrice) || 0,    // í™•ì‹¤íˆ Numberë¡œ ë³€í™˜
          Number(item.inputs.sellingPriceKRW) || 0,
          Number(item.inputs.sellingPriceJPY) || 0,
          Number(item.inputs.discountRate) || 0,
          Number(item.inputs.additionalCost) || 0,
          Number(item.inputs.weight) || 0,
          getShippingProviderName(item.inputs.shippingProvider),
          Number(item.inputs.coupangFeeRate) || 0,
          Number(item.inputs.vatRefundRate) || 10,
          Number(item.results.totalCost) || 0,
          Number(item.results.shippingFee) || 0,
          Number(item.results.vatRefundAmount) || 0,
          Number(item.results.marginRate) || 0,      // ë§ˆì§„ìœ¨ì´ ë¨¼ì €
          Number(item.results.marginAmount) || 0,    // ë§ˆì§„ê¸ˆì•¡ì´ ë‚˜ì¤‘
          Number(item.results.totalProfit) || 0
        ];

        const dataRow = worksheet.addRow(row);

        // ë°ì´í„° í–‰ ìŠ¤íƒ€ì¼ë§
        dataRow.eachCell((cell, colNumber) => {
          cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
          };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };

          // ì²œ ë‹¨ìœ„ ì½¤ë§ˆê°€ í•„ìš”í•œ ì»¬ëŸ¼ë“¤
          const commaFormatColumns = [5, 6, 7, 10, 14, 15, 16, 18, 19];
          // ì œí’ˆì›ê°€, íŒë§¤ê°€(ì›), íŒë§¤ê°€(ì—”), ë¬´ê²Œ, ì´ë¹„ìš©, ë°°ì†¡ë¹„, ë¶€ê°€ì„¸í™˜ê¸‰, ë§ˆì§„ê¸ˆì•¡, ì‹¤ì œìˆ˜ìµ

          if (commaFormatColumns.includes(colNumber)) {
            // ë””ë²„ê¹…: ì…€ ê°’ê³¼ íƒ€ì… í™•ì¸
            console.log(`ì»¬ëŸ¼ ${colNumber}: ê°’=${cell.value}, íƒ€ì…=${typeof cell.value}`);

            // ê°’ì´ ìˆ«ìì¸ì§€ í™•ì¸í•˜ê³  ê°•ì œ ë³€í™˜
            if (typeof cell.value === 'string' && !isNaN(cell.value)) {
              cell.value = Number(cell.value);
            }

            // ì—‘ì…€ ì½¤ë§ˆ ë²„íŠ¼ê³¼ ë™ì¼í•œ í˜•ì‹ ì ìš©
            cell.numFmt = '#,##0';
            cell.type = ExcelJS.ValueType.Number; // íƒ€ì… ê°•ì œ ì§€ì •
          }
        });
      });

      // ì»¬ëŸ¼ ë„ˆë¹„ ë° í˜•ì‹ ì„¤ì •
      worksheet.columns = [
        { width: 8 },   // ìˆœë²ˆ
        { width: 25 },  // ì œí’ˆëª…
        { width: 20 },  // ì €ì¥ì¼ì‹œ
        { width: 10, numFmt: '#,##0' },  // í™˜ìœ¨
        { width: 12, numFmt: '#,##0' },  // ì œí’ˆì›ê°€
        { width: 12, numFmt: '#,##0' },  // íŒë§¤ê°€(ì›)
        { width: 12, numFmt: '#,##0' },  // íŒë§¤ê°€(ì—”)
        { width: 12 },  // í• ì¸ìœ¨
        { width: 12, numFmt: '#,##0' },  // ë¶€ìì¬ë¹„ìš©
        { width: 10, numFmt: '#,##0' },  // ë¬´ê²Œ
        { width: 18 },  // ë°°ì†¡ëŒ€í–‰ì§€
        { width: 14 },  // íí…ìˆ˜ìˆ˜ë£Œ
        { width: 14 },  // ë¶€ê°€ì„¸í™˜ê¸‰ë¥ 
        { width: 12, numFmt: '#,##0' },  // ì´ë¹„ìš©
        { width: 12, numFmt: '#,##0' },  // ë°°ì†¡ë¹„
        { width: 12, numFmt: '#,##0' },  // ë¶€ê°€ì„¸í™˜ê¸‰
        { width: 12 },  // ë§ˆì§„ìœ¨
        { width: 12, numFmt: '#,##0' },  // ë§ˆì§„ê¸ˆì•¡
        { width: 12, numFmt: '#,##0' }   // ì‹¤ì œìˆ˜ìµ
      ];

      // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ/ì‹œê°„ í¬í•¨)
      const now = new Date();
      const fileName = `íí…_ë§ˆì§„ìœ¨_ê³„ì‚°_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.xlsx`;

      // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      window.URL.revokeObjectURL(url);

      alert(`ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${fileName}`);
    }

    // ë°°ì†¡ëŒ€í–‰ì§€ ì½”ë“œë¥¼ í•œê¸€ëª…ìœ¼ë¡œ ë³€í™˜
    function getShippingProviderName(code) {
      const providers = {
        'KSE_air': 'KSE í•­ê³µ',
        'KSE_sea': 'KSE í•´ìƒ',
        'Synergy_slim': 'Synergy ìŠ¬ë¦¼',
        'Synergy_svip': 'Synergy SVIP',
        'Trackslosis': 'íŠ¸ë™ìŠ¬ë¡œì‹œìŠ¤'
      };
      return providers[code] || code;
    }

    // ë°°ì†¡ëŒ€í–‰ì§€ í•œê¸€ëª…ì„ ì½”ë“œë¡œ ë³€í™˜
    function getShippingProviderCode(name) {
      const providers = {
        'KSE í•­ê³µ': 'KSE_air',
        'KSE í•´ìƒ': 'KSE_sea',
        'Synergy ìŠ¬ë¦¼': 'Synergy_slim',
        'Synergy SVIP': 'Synergy_svip',
        'íŠ¸ë™ìŠ¬ë¡œì‹œìŠ¤': 'Trackslosis'
      };

      const trimmedName = String(name || '').trim();

      // ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ê²½ìš°
      if (providers[trimmedName]) {
        console.log(`ë°°ì†¡ëŒ€í–‰ì§€ ë³€í™˜ ì„±ê³µ: "${trimmedName}" â†’ "${providers[trimmedName]}"`);
        return providers[trimmedName];
      }

      // ì´ë¯¸ ì½”ë“œ í˜•íƒœì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
      const validCodes = ['KSE_air', 'KSE_sea', 'Synergy_slim', 'Synergy_svip', 'Trackslosis'];
      if (validCodes.includes(trimmedName)) {
        console.log(`ë°°ì†¡ëŒ€í–‰ì§€ ì½”ë“œ ìœ ì§€: "${trimmedName}"`);
        return trimmedName;
      }

      // ê¸°ë³¸ê°’ìœ¼ë¡œ ì²« ë²ˆì§¸ ì˜µì…˜ ë°˜í™˜
      console.warn(`ë°°ì†¡ëŒ€í–‰ì§€ ë³€í™˜ ì‹¤íŒ¨: "${trimmedName}" â†’ ê¸°ë³¸ê°’ "KSE_air" ì‚¬ìš©`);
      return 'KSE_air';
    }

    // ë“œë˜ê·¸ì•¤ë“œë¡­ ë° íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
    function initializeFileUpload() {
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');

      console.log('initializeFileUpload í˜¸ì¶œë¨');
      console.log('dropZone:', dropZone);
      console.log('fileInput:', fileInput);

      if (!dropZone || !fileInput) {
        console.error('dropZone ë˜ëŠ” fileInputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
      dropZone.replaceWith(dropZone.cloneNode(true));
      const newDropZone = document.getElementById('dropZone');
      const newFileInput = document.getElementById('fileInput');

      // í´ë¦­ ì´ë²¤íŠ¸
      newDropZone.addEventListener('click', (e) => {
        console.log('dropZone í´ë¦­ë¨');
        newFileInput.click();
      });

      // ë“œë˜ê·¸ì˜¤ë²„ ì´ë²¤íŠ¸
      newDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        console.log('dragover ì´ë²¤íŠ¸');
        newDropZone.style.borderColor = 'var(--primary-color)';
        newDropZone.style.backgroundColor = '#e8f4fd';
      });

      // ë“œë˜ê·¸ë¦¬ë¸Œ ì´ë²¤íŠ¸
      newDropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        console.log('dragleave ì´ë²¤íŠ¸');
        newDropZone.style.borderColor = '#ccc';
        newDropZone.style.backgroundColor = '#f9f9f9';
      });

      // ë“œë¡­ ì´ë²¤íŠ¸
      newDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        console.log('drop ì´ë²¤íŠ¸', e.dataTransfer.files);
        newDropZone.style.borderColor = '#ccc';
        newDropZone.style.backgroundColor = '#f9f9f9';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileUpload(files[0]);
        }
      });

      // íŒŒì¼ ì…ë ¥ ë³€ê²½ ì´ë²¤íŠ¸
      newFileInput.addEventListener('change', (e) => {
        console.log('fileInput ë³€ê²½ë¨', e.target.files);
        if (e.target.files.length > 0) {
          handleFileUpload(e.target.files[0]);
        }
      });

      console.log('ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    async function handleFileUpload(file) {
      // íŒŒì¼ í™•ì¥ì ê²€ì‚¬
      const fileName = file.name.toLowerCase();
      if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
        alert('ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      // í™•ì¸ ëŒ€í™”ìƒì
      const confirmMessage = `ì—‘ì…€ íŒŒì¼ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: í˜„ì¬ ì €ì¥ëœ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ì—‘ì…€ íŒŒì¼ì˜ ë°ì´í„°ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.\n\níŒŒì¼ëª…: ${file.name}`;
      if (!confirm(confirmMessage)) {
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('fileInput').value = '';
        return;
      }

      try {
        const workbook = new ExcelJS.Workbook();
        const arrayBuffer = await file.arrayBuffer();
        await workbook.xlsx.load(arrayBuffer);

        const worksheet = workbook.getWorksheet(1); // ì²« ë²ˆì§¸ ì‹œíŠ¸
        if (!worksheet) {
          alert('ì›Œí¬ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // í—¤ë” ê²€ì¦
        const expectedHeaders = [
          'ìˆœë²ˆ', 'ì œí’ˆëª…', 'ì €ì¥ì¼ì‹œ', 'í™˜ìœ¨', 'ì œí’ˆì›ê°€', 'íŒë§¤ê°€(ì›)', 'íŒë§¤ê°€(ì—”)',
          'í• ì¸ìœ¨(%)', 'ë¶€ìì¬ë¹„ìš©', 'ë¬´ê²Œ(kg)', 'ë°°ì†¡ëŒ€í–‰ì§€', 'íí…ìˆ˜ìˆ˜ë£Œ(%)',
          'ë¶€ê°€ì„¸í™˜ê¸‰ë¥ (%)', 'ì´ë¹„ìš©', 'ë°°ì†¡ë¹„', 'ë¶€ê°€ì„¸í™˜ê¸‰', 'ë§ˆì§„ìœ¨(%)', 'ë§ˆì§„ê¸ˆì•¡', 'ì‹¤ì œìˆ˜ìµ'
        ];

        const headerRow = worksheet.getRow(1);
        const actualHeaders = [];

        // ì‹¤ì œ í—¤ë” ì½ê¸°
        headerRow.eachCell((cell, colNumber) => {
          actualHeaders.push(String(cell.value || '').trim());
        });

        // í—¤ë” ê²€ì¦
        let isValidFormat = true;
        const missingHeaders = [];

        for (let i = 0; i < expectedHeaders.length; i++) {
          if (actualHeaders[i] !== expectedHeaders[i]) {
            isValidFormat = false;
            if (!actualHeaders[i]) {
              missingHeaders.push(`${i + 1}ë²ˆì§¸ ì»¬ëŸ¼ì´ ë¹„ì–´ìˆìŒ`);
            } else {
              missingHeaders.push(`${i + 1}ë²ˆì§¸ ì»¬ëŸ¼: "${actualHeaders[i]}" (ì˜ˆìƒ: "${expectedHeaders[i]}")`);
            }
          }
        }

        if (!isValidFormat) {
          let errorMessage = 'âŒ ì—‘ì…€ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\n';
          errorMessage += 'ğŸ” ë¬¸ì œì :\n';
          missingHeaders.slice(0, 5).forEach(header => {
            errorMessage += `â€¢ ${header}\n`;
          });
          if (missingHeaders.length > 5) {
            errorMessage += `â€¢ ... ì™¸ ${missingHeaders.length - 5}ê°œ ë”\n`;
          }
          errorMessage += '\nğŸ“‹ ì˜¬ë°”ë¥¸ í˜•ì‹:\n';
          errorMessage += 'ì´ í”„ë¡œê·¸ë¨ì—ì„œ "ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°"ë¡œ ìƒì„±ëœ íŒŒì¼ë§Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n';
          errorMessage += 'ğŸ’¡ í•´ê²°ë°©ë²•:\n';
          errorMessage += '1. ì´ ê³„ì‚°ê¸°ì—ì„œ ë°ì´í„°ë¥¼ ê³„ì‚°í•˜ê³  ì €ì¥\n';
          errorMessage += '2. "ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°" ë²„íŠ¼ìœ¼ë¡œ íŒŒì¼ ìƒì„±\n';
          errorMessage += '3. ìƒì„±ëœ íŒŒì¼ë§Œ ê°€ì ¸ì˜¤ê¸°ì— ì‚¬ìš©';

          alert(errorMessage);
          return;
        }

        const importedData = [];
        let rowCount = 0;

        // í—¤ë” í–‰ ê±´ë„ˆë›°ê³  ë°ì´í„° ì½ê¸° (2í–‰ë¶€í„°)
        worksheet.eachRow((row, rowNumber) => {
          if (rowNumber === 1) return; // í—¤ë” í–‰ ê±´ë„ˆë›°ê¸°

          const rowData = row.values;
          if (!rowData[2] || String(rowData[2]).trim() === '') return; // ì œí’ˆëª…ì´ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°

          try {
            // í•„ìˆ˜ ë°ì´í„° ê²€ì¦
            const requiredFields = {
              'ì œí’ˆëª…': rowData[2],
              'í™˜ìœ¨': rowData[4],
              'ì œí’ˆì›ê°€': rowData[5],
              'íŒë§¤ê°€(ì›)': rowData[6],
              'ë¬´ê²Œ': rowData[10]
            };

            let hasError = false;
            for (const [fieldName, value] of Object.entries(requiredFields)) {
              if (!value || (typeof value === 'number' && value <= 0)) {
                console.warn(`í–‰ ${rowNumber}: ${fieldName} í•„ë“œê°€ ë¹„ì–´ìˆê±°ë‚˜ ì˜ëª»ëœ ê°’ì…ë‹ˆë‹¤.`);
                hasError = true;
              }
            }

            if (hasError) return; // í•„ìˆ˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
            const calculationData = {
              productName: String(rowData[2] || ''),
              savedAt: String(rowData[3] || new Date().toLocaleString()),
              inputs: {
                exchangeRate: Number(rowData[4]) || 0,
                productPrice: Number(rowData[5]) || 0,
                sellingPriceKRW: Number(rowData[6]) || 0,
                sellingPriceJPY: Number(rowData[7]) || 0,
                discountRate: Number(rowData[8]) || 0,
                additionalCost: Number(rowData[9]) || 0,
                weight: Number(rowData[10]) || 0,
                shippingProvider: getShippingProviderCode(String(rowData[11] || '')),
                coupangFeeRate: Number(rowData[12]) || 0,
                vatRefundRate: Number(rowData[13]) || 10 // ë¶€ê°€ì„¸í™˜ê¸‰ë¥  ì¶”ê°€
              },
              results: {
                totalCost: Number(rowData[14]) || 0,
                shippingFee: Number(rowData[15]) || 0,
                vatRefundAmount: Number(rowData[16]) || 0,
                marginRate: Number(rowData[17]) || 0,    // ë§ˆì§„ìœ¨ì´ ë¨¼ì €
                marginAmount: Number(rowData[18]) || 0,  // ë§ˆì§„ê¸ˆì•¡ì´ ë‚˜ì¤‘
                totalProfit: Number(rowData[19]) || 0
              }
            };

            importedData.push(calculationData);
            rowCount++;
          } catch (error) {
            console.warn(`í–‰ ${rowNumber} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
          }
        });

        if (importedData.length === 0) {
          alert('ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // í˜„ì¬ í™˜ìœ¨ë¡œ ëª¨ë“  ë°ì´í„° ì—…ë°ì´íŠ¸
        const currentExchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 0;
        importedData.forEach(data => {
          data.inputs.exchangeRate = currentExchangeRate;
        });

        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ìƒˆ ë°ì´í„° ì €ì¥
        localStorage.setItem('marginCalculations', JSON.stringify(importedData));

        // í™”ë©´ ì—…ë°ì´íŠ¸
        loadSavedData();

        alert(`ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!\nê°€ì ¸ì˜¨ ë°ì´í„°: ${rowCount}ê°œ\n\nğŸ’¡ ëª¨ë“  ë°ì´í„°ì˜ í™˜ìœ¨ì´ í˜„ì¬ í™˜ìœ¨(${currentExchangeRate.toFixed(2)}ì›/ì—”)ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);

      } catch (error) {
        console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
        alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\níŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      } finally {
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('fileInput').value = '';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function () {
      updateExchangeRate();
      loadSavedData();
      // ì´ˆê¸°ì—ëŠ” ì €ì¥ëª©ë¡ íƒ­ì´ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë¯€ë¡œ initializeFileUploadëŠ” íƒ­ ì „í™˜ ì‹œì—ë§Œ í˜¸ì¶œ
    });
  </script>
</body>

</html>